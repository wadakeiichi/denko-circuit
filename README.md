# 複線図シミュレータ

## 概要
- 単相2線式 100V の電源系統を想定した複線図を、ブラウザ上で直感的に作図・検証できるツールです。
- 電源、単極・三路スイッチ、コンセント、ランプレセプタクル、パイロットランプの配置と配線をシミュレーションできます。
- 芯線の色・太さ、スリーブ刻印、対応マーク、配線経路の検証をサポートします。

## 画面構成
- **サイドバー**
  - 芯線設定: 使用する芯線の色（黒/青/赤）と太さ（1.6mm/2.0mm）を選択。
  - ツール: 「配線」「消しゴム」「刻印」を切り替え。
  - 器具パレット: 各器具を選んでキャンバスへ配置。
  - 対応マーク: スイッチ／三路スイッチ／ランプ／パイロットランプに仮名マークを割り当て。
  - 操作方法: 主な操作のチートシート。
- **キャンバスヘッダー**
  - 選択中の芯線色・太さを表示。
  - スイッチ状態ボタンで主スイッチの入切を確認。
  - ランプ・コンセントの通電状態を自動表示。
  - `戻る` ボタンで直前の操作を取り消し（最大50履歴）。
  - `配線チェック` で色・太さの整合性を診断。
  - `スリーブチェック` でスリーブ刻印／電線本数を確認。
- **キャンバス**
  - ドラッグ＆ドロップで器具や接続点を移動し、配線を作図。

## 基本操作
- 器具パレットで器具を選び、キャンバスをクリックして配置。
- コネクタをダブルクリックすると配線開始。終点のコネクタをクリックで接続完了。
- 配線途中で背景をクリックすると折り点（コーナー）を追加。
- 既存配線をダブルクリックすると分岐用の接続点（J）を挿入。
- 空白をダブルクリックすると単独の接続点を新規作成。
- 接続点はドラッグで位置調整可能。器具も外枠をドラッグで移動。
- `Esc` キーで現在の配線操作や器具選択をキャンセル。

## ツールモード
- **配線**: 通常の配線作図モード。芯線色/太さはサイドバーで選択。
- **消しゴム**: 器具・配線・接続点をクリックで削除。
- **刻印**: サイドバーで選んだスリーブ種別を接続点へ刻印。刻印中も `Ctrl+クリック` でメニューを開けます。

## コンテキストメニュー
- `Ctrl + クリック`（接続点）: スリーブ刻印の種類を選択。
- `Ctrl + クリック`（配線）: 芯線の色と太さを配線単位で変更。
- メニューを開いた状態で別の場所をクリックすると自動で閉じます。

## ショートカットとジェスチャ
- `Shift + クリック`（スイッチ/三路スイッチ）: その場で入切・切替を操作。
- `Alt + クリック`（回転可能な器具）: 時計回りに90°回転。`Alt + Shift + クリック` で反時計回り。
- `Ctrl + Shift + クリック`（配線上）: 両端の接続点は維持したまま、他の配線を避ける直角配線に自動再ルーティング。経路が見つからない場合はステータスに理由が表示されます。
- 配線中に `Esc` でキャンセル、背景クリックで折り点を追加。
- 接続点や器具をドラッグすると位置を調整可能。ドラッグ開始中はキャンバスカーソルが「掴む」表示に切り替わります。

## 検証・表示機能
- **配線チェック**: 同一端子に複数色が混在していないか、スイッチとランプの接続が適切かなどを診断します。
- **スリーブチェック**: 接続点の刻印、電線本数、芯線太さとの整合性をチェックし、問題がある場合にはステータスに表示します。
- **ステータス表示**: メッセージ領域に操作ガイドや検証結果が表示され、一定時間後に自動クリアされます。
- **ランプ/コンセント指示灯**: 現在の配線状態とスイッチ設定に応じて点灯・通電状態をシミュレーション表示。
- **対応マーク**: スイッチや三路スイッチ、ランプ、パイロットランプに対して対応する仮名（イロハ…）を割り振り、図面上に表示します。

## 履歴と復元
- すべての編集操作は履歴に記録され、`戻る` ボタンで直前の状態に戻れます（最大50手順）。
- 履歴を戻した後でも操作を続ければ新しい履歴として上書きされます。

## 補足
- 初期状態では電源・単極スイッチ・コンセント・ランプレセプタクルが配置されています。必要に応じて配置や器具数を調整してください。
- `Ctrl+Shift+クリック` での再ルーティングはクリック位置に近い折返しを優先するため、希望する経路付近を指定すると意図した形状になりやすくなります。
- 配線が密集している場合は、接続点や配線の位置を少し広げてから再ルーティングや刻印を行うと判読しやすい図面になります。
